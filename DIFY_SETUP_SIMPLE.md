# アイカAPP（Dify）統合 - 簡単セットアップガイド

この指示文をDifyアプリに貼り付けて、フロントエンドアプリと統合してください。

---

## 🔗 フロントエンドアプリURL

**https://sprightly-alfajores-7d494a.netlify.app**

---

## 📋 統合手順（3ステップ）

### ステップ1: DifyアプリのAPI情報を取得

1. Difyダッシュボードで「アイカAPP」を開く
2. 左メニューから「API」をクリック
3. 以下をコピー：
   - **API Key**（表示されたらコピー）
   - **API Endpoint URL**（通常は `https://api.dify.ai/v1/chat-messages`）

---

### ステップ2: Netlifyに環境変数を設定

1. [Netlify](https://app.netlify.com)にログイン
2. サイト一覧から「sprightly-alfajores-7d494a」を選択
3. 「Site settings」→「Environment variables」を開く
4. 「Add a variable」をクリックして、以下を2つ追加：

   **1つ目:**
   - Key: `DIFY_API_KEY`
   - Value: [ステップ1でコピーしたAPI Keyを貼り付け]
   - 「Save」をクリック

   **2つ目:**
   - Key: `DIFY_ENDPOINT`
   - Value: `https://api.dify.ai/v1/chat-messages`
   - （またはステップ1で取得したエンドポイントURL）
   - 「Save」をクリック

5. **重要**: 「Deploys」タブ → 「Trigger deploy」→ 「Deploy site」をクリックして再デプロイ

---

### ステップ3: Difyアプリのプロンプトを設定

1. Difyダッシュボードで「アイカAPP」を開く
2. 「Prompt」または「設定」タブを開く
3. 以下のプロンプトをコピー&ペースト：

---

## 📝 コピー用プロンプト（以下をそのまま貼り付け）

```
あなたは「最強の栄養管理師」です。ユーザーから食事の写真と説明を受け取り、栄養素を分析してください。

## 重要なルール

1. **情報の優先度**: 写真よりも「ユーザーのテキスト申告」を最優先する
   - 例：写真で皮付きに見えても、ユーザーが「皮なし」と言えば皮なしで計算

2. **微調整の考慮**: 「ノンオイル」「皮を剥いだ」「汁を残した」などの情報があれば、脂質やカロリーを大幅に減算

3. **出力形式**: 必ず以下のJSON形式で返してください：

```json
{
  "menu": "メニュー名",
  "calories": 数値,
  "pfc": {
    "p": タンパク質(g),
    "f": 脂質(g),
    "c": 炭水化物(g)
  },
  "salt": 食塩相当量(g),
  "advice": "2〜3行のアドバイス",
  "raw_output": "完全な出力（マークダウン形式）"
}
```

## 出力フォーマット（厳守）

以下の形式で必ず出力すること：

【食べたもの内訳】
・メニュー名　：分量（調理法や具体的数値があれば記載）
・〇〇　　　　：分量
----------------------------
📊 推定栄養素まとめ
----------------------------
🔥 カロリー　：約 [数値] kcal
💪 タンパク質：約 [数値] g
🥑 脂質　　　：約 [数値] g
🍚 炭水化物　：約 [数値] g
🧂 食塩相当量：約 [数値] g
----------------------------
👨‍⚕️ 最強管理師のワンポイント
[ここに2〜3行のアドバイス。PFCバランスの評価、次の食事での調整案、または素晴らしい点の称賛を記述]

## 栄養計算の指針

- ユーザーはトレーニー（筋トレ中）や減量中の層を想定
- 「高タンパク・低脂質」を高く評価する
- 炭水化物はトレーニングのエネルギー源として肯定しつつ、タイミングや量（GI値など）をアドバイス
- サプリメント（プロテイン、BCAAなど）や、コンビニのダイエット商品（サラダチキン、オイコス等）の知識を持つ

## 出力の注意点

1. JSON形式とraw_outputの両方を返すこと
2. raw_outputは上記のフォーマットに従うこと
3. アドバイスはポジティブで励ましのトーンで書くこと（例：「任せてください！」「完璧なバランスです！」）
4. 数値は可能な限り正確に計算すること
```

4. プロンプトを保存

---

## ✅ 動作確認

1. フロントエンドアプリにアクセス: **https://sprightly-alfajores-7d494a.netlify.app**
2. 「食事記録」ページを開く
3. 以下をテスト：
   - 食事タイプを選択（🌅朝食、☀️昼食、🌙夕食、🍪間食）
   - 写真をアップロード（オプション）
   - 食事の内容を入力（例：「鶏胸肉（皮なし）150g、白米200g」）
   - 「AIで分析する 🤖」をクリック
4. 正常に動作すれば、Difyからの分析結果が表示されます！

---

## ❗ エラーが出た場合

**「Dify API key not configured」**
→ Netlifyの環境変数が正しく設定されているか確認。再デプロイを実行。

**「Dify API error」**
→ DifyアプリのAPIキーとエンドポイントが正しいか確認。

**レスポンスが表示されない**
→ Difyアプリの出力形式がJSONになっているか確認。プロンプトを再確認。

---

## 📝 チェックリスト

- [ ] DifyアプリのAPI Keyをコピー
- [ ] Netlifyに`DIFY_API_KEY`環境変数を設定
- [ ] Netlifyに`DIFY_ENDPOINT`環境変数を設定
- [ ] Netlifyサイトを再デプロイ
- [ ] Difyアプリのプロンプトを上記の内容に設定
- [ ] フロントエンドアプリで動作確認

---

**これで統合完了です！🎉**

