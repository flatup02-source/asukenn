# アイカAPP（Dify）統合指示文

この指示文をDifyアプリのプロンプトまたは指示欄に貼り付けてください。

---

## 📱 フロントエンドアプリのURL

**アプリURL**: `https://sprightly-alfajores-7d494a.netlify.app`

または最新のNetlify URLを確認してください。

---

## 🔗 統合方法

### 1. Difyアプリの設定確認

#### API設定の確認
1. Difyダッシュボードで「アイカAPP」を開く
2. 「API」タブを選択
3. 以下の情報を確認・コピー：
   - **API Endpoint URL**: `https://api.dify.ai/v1/chat-messages` または類似
   - **API Key**: アプリのAPIキー（表示されたらコピー）

#### アプリの出力形式設定
アプリが以下のJSON形式で返すように設定してください：

```json
{
  "menu": "メニュー名",
  "calories": 450,
  "pfc": {
    "p": 40,
    "f": 5,
    "c": 60
  },
  "salt": 1.2,
  "advice": "アドバイステキスト",
  "raw_output": "完全な出力テキスト（マークダウン形式可）"
}
```

---

### 2. Netlify環境変数の設定

1. [Netlify](https://app.netlify.com)にログイン
2. サイト「sprightly-alfajores-7d494a」を選択
3. 「Site settings」→「Environment variables」を開く
4. 以下の環境変数を追加：

```
変数名: DIFY_API_KEY
値: [DifyアプリのAPIキーを貼り付け]

変数名: DIFY_ENDPOINT
値: https://api.dify.ai/v1/chat-messages
（またはDifyアプリで表示されたエンドポイントURL）
```

5. 「Save」をクリック
6. **重要**: 環境変数を変更したら、サイトを再デプロイしてください
   - 「Deploys」タブ → 「Trigger deploy」→ 「Deploy site」

---

### 3. Difyアプリのプロンプト設定

#### 入力変数の設定
アプリの「Variables」セクションで、以下の変数を設定：

- `text`: テキスト型 - 食事の説明を受け取る
- `photo`: ファイル型（オプション）- 写真を受け取る
- `meal_type`: テキスト型 - 食事タイプ（朝食、昼食、夕食、間食）

#### プロンプトの例

```
あなたは「最強の栄養管理師」です。ユーザーから食事の写真と説明を受け取り、栄養素を分析してください。

## 重要なルール

1. **情報の優先度**: 写真よりも「ユーザーのテキスト申告」を最優先する
   - 例：写真で皮付きに見えても、ユーザーが「皮なし」と言えば皮なしで計算

2. **微調整の考慮**: 「ノンオイル」「皮を剥いだ」「汁を残した」などの情報があれば、脂質やカロリーを大幅に減算

3. **出力形式**: 必ず以下のJSON形式で返してください：

```json
{
  "menu": "メニュー名",
  "calories": 数値,
  "pfc": {
    "p": タンパク質(g),
    "f": 脂質(g),
    "c": 炭水化物(g)
  },
  "salt": 食塩相当量(g),
  "advice": "2〜3行のアドバイス",
  "raw_output": "完全な出力（マークダウン形式）"
}
```

## 出力フォーマット（厳守）

以下の形式で必ず出力すること：

【食べたもの内訳】
・メニュー名　：分量（調理法や具体的数値があれば記載）
・〇〇　　　　：分量
----------------------------
📊 推定栄養素まとめ
----------------------------
🔥 カロリー　：約 [数値] kcal
💪 タンパク質：約 [数値] g
🥑 脂質　　　：約 [数値] g
🍚 炭水化物　：約 [数値] g
🧂 食塩相当量：約 [数値] g
----------------------------
👨‍⚕️ 最強管理師のワンポイント
[ここに2〜3行のアドバイス。PFCバランスの評価、次の食事での調整案、または素晴らしい点の称賛を記述]

## 栄養計算の指針

- ユーザーはトレーニー（筋トレ中）や減量中の層を想定
- 「高タンパク・低脂質」を高く評価する
- 炭水化物はトレーニングのエネルギー源として肯定しつつ、タイミングや量（GI値など）をアドバイス
- サプリメント（プロテイン、BCAAなど）や、コンビニのダイエット商品（サラダチキン、オイコス等）の知識を持つ

## 出力の注意点

1. JSON形式とraw_outputの両方を返すこと
2. raw_outputは上記のフォーマットに従うこと
3. アドバイスはポジティブで励ましのトーンで書くこと
4. 数値は可能な限り正確に計算すること
```

---

### 4. 動作確認

1. フロントエンドアプリ（`https://sprightly-alfajores-7d494a.netlify.app`）にアクセス
2. 「食事記録」ページで以下をテスト：
   - 食事タイプを選択（朝食、昼食、夕食、間食）
   - 写真をアップロード（オプション）
   - 食事の内容を入力
   - 「AIで分析する」をクリック
3. 正常に動作すれば、Difyからのレスポンスが表示されます

---

### 5. トラブルシューティング

#### エラーが発生する場合

**「Dify API key not configured」エラー**
→ Netlifyの環境変数が正しく設定されているか確認

**「Dify API error」エラー**
→ DifyアプリのAPIキーとエンドポイントが正しいか確認

**レスポンスが正しく表示されない**
→ Difyアプリの出力形式がJSONになっているか確認

**CORSエラー**
→ Netlify Functionが正しくデプロイされているか確認

---

### 6. デプロイ確認

コードは既にGitHubにプッシュ済みです。Netlifyが自動デプロイしているはずですが、手動で再デプロイする場合：

1. Netlifyダッシュボードで「Deploys」タブを開く
2. 「Trigger deploy」→「Deploy site」をクリック

---

## 📝 チェックリスト

- [ ] DifyアプリのAPIキーとエンドポイントを確認
- [ ] Netlifyの環境変数に`DIFY_API_KEY`と`DIFY_ENDPOINT`を設定
- [ ] Difyアプリのプロンプトを上記の形式に設定
- [ ] Difyアプリの出力形式がJSONになっているか確認
- [ ] Netlifyサイトを再デプロイ
- [ ] フロントエンドアプリで動作確認

---

## 🔄 今後の更新

コードを更新した場合は、GitHubにプッシュすると自動的にNetlifyにデプロイされます：

```bash
git add .
git commit -m "更新内容"
git push
```

---

## 📞 サポート

問題が発生した場合：
1. Netlifyの「Functions」タブでログを確認
2. ブラウザの開発者ツール（F12）でコンソールエラーを確認
3. Difyアプリのログを確認

---

**統合完了後、フロントエンドアプリからDifyアプリ（アイカAPP）を呼び出せるようになります！**

